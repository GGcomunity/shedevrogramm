<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>–®–µ–¥–µ–≤—Ä–æ–ì—Ä–∞–º–º - SMALLS</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 10px;
        }

        #app {
            width: 100%;
            max-width: 500px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .alpha-banner {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .screen {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo {
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-logo img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .avatar:hover {
            transform: scale(1.05);
        }

        .avatar.large {
            width: 100px;
            height: 100px;
            font-size: 2.5rem;
            margin: 0 auto 15px;
            border: 4px solid #667eea;
        }

        .avatar.small {
            width: 30px;
            height: 30px;
            font-size: 1rem;
            border-width: 2px;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f5f5f5;
        }

        .form-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #667eea;
            font-weight: 500;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #667eea;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-smalls {
            background: #ff6b6b;
            color: white;
        }

        .switch-text {
            text-align: center;
            color: #667eea;
            cursor: pointer;
            margin-top: 10px;
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            color: #f44336;
            font-size: 0.85rem;
            margin-top: 10px;
            text-align: center;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 60px;
            padding: 12px 5px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab:not(.active) {
            background: #f0f0f0;
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .contacts-list, .strangers-list, .groups-list, .channels-list {
            list-style: none;
        }

        .contact-item, .stranger-item, .group-item, .channel-item {
            background: white;
            padding: 15px;
            margin-bottom: 8px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .contact-item.pinned, .group-item.pinned, .channel-item.pinned {
            border-left: 4px solid #ffd700;
            background: linear-gradient(to right, white, #fff9e6);
        }

        .contact-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            cursor: pointer;
        }

        .contact-info h4 {
            color: #667eea;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .contact-info p {
            color: #666;
            font-size: 0.85rem;
        }

        .pin-badge {
            background: #ffd700;
            color: #333;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .subscriber-badge {
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .unread-badge {
            background: #f44336;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .chat-actions {
            display: flex;
            gap: 5px;
        }

        .chat-btn, .add-btn, .pin-btn, .group-btn, .subscribe-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .subscribe-btn {
            background: #4caf50;
        }

        .pin-btn {
            background: #ffd700;
            color: #333;
        }

        .add-btn {
            background: #667eea;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-info h3 {
            font-size: 1.1rem;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-header-info p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .message {
            max-width: 80%;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
        }

        .message.sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            align-self: flex-end;
        }

        .message.received {
            background: white;
            color: #333;
            align-self: flex-start;
        }

        .message.fwd {
            font-style: italic;
        }

        .message.fwd::before {
            content: "üìé –ü–µ—Ä–µ—Å–ª–∞–Ω–æ";
            display: block;
            font-size: 0.7rem;
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .message.deleted {
            opacity: 0.6;
            font-style: italic;
            background: #f0f0f0;
        }

        .message.deleted::before {
            content: "üóëÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ";
            display: block;
            font-size: 0.7rem;
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .message-sender {
            font-size: 0.75rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 2px;
        }

        .message.sent .message-sender {
            color: rgba(255,255,255,0.9);
        }

        .message small {
            display: block;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.8);
            margin-top: 3px;
        }

        .message.received small {
            color: #666;
        }

        .message img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            cursor: pointer;
        }

        .message a {
            color: inherit;
            text-decoration: underline;
            word-break: break-all;
        }

        .message.sent a {
            color: white;
        }

        .message-actions {
            position: absolute;
            top: -10px;
            right: -10px;
            display: none;
            gap: 5px;
            background: white;
            padding: 5px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .message:hover .message-actions {
            display: flex;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }

        .forward-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }

        .message-input-area {
            background: white;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
            border-top: 1px solid #eee;
        }

        .message-input-area input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
        }

        .attach-btn, .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .attach-btn {
            background: #f0f0f0;
            color: #667eea;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .forward-list, .members-list, .subscribers-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #eee;
            border-radius: 10px;
        }

        .forward-item, .member-item, .subscriber-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .forward-item:hover, .member-item:hover, .subscriber-item:hover {
            background: #f5f5f5;
        }

        .forward-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #667eea;
        }

        .admin-badge {
            background: #ffd700;
            color: #333;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .owner-badge {
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .group-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .forward-message {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-style: italic;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            z-index: 2000;
            animation: slideUp 0.3s;
        }

        .notification.success {
            background: #4caf50;
        }

        .notification.error {
            background: #f44336;
        }

        .notification.info {
            background: #2196f3;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .read-status {
            font-size: 0.7rem;
            margin-left: 5px;
            opacity: 0.7;
        }

        .sent .read-status {
            color: rgba(255,255,255,0.6);
        }

        .received .read-status {
            color: #999;
        }

        .unread-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f44336;
            margin-left: 5px;
        }

        .settings-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .channel-description {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #666;
        }

        .smalls-feed {
            height: calc(100vh - 200px);
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
        }

        .smalls-video-container {
            height: 100%;
            min-height: 500px;
            scroll-snap-align: start;
            position: relative;
            background: black;
            margin-bottom: 10px;
            border-radius: 15px;
            overflow: hidden;
        }

        .smalls-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        .smalls-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
        }

        .smalls-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .smalls-description {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .smalls-author {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .smalls-author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
            border: 2px solid white;
        }

        .smalls-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .smalls-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .smalls-chef-button {
            background: none;
            border: 2px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        .smalls-chef-button.active {
            background: white;
            color: #667eea;
        }

        .smalls-chef-icon {
            font-size: 1.2rem;
        }

        .smalls-comments-section {
            background: white;
            border-radius: 15px 15px 0 0;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .smalls-comment {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .smalls-comment-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            flex-shrink: 0;
        }

        .smalls-comment-content {
            flex: 1;
        }

        .smalls-comment-author {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 3px;
        }

        .smalls-comment-text {
            font-size: 0.9rem;
            color: #333;
        }

        .smalls-comment-time {
            font-size: 0.7rem;
            color: #999;
            margin-top: 3px;
        }

        .smalls-add-comment {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        .smalls-add-comment input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
        }

        .smalls-add-comment button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .profile-chef-count {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .profile-chef-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background: #f0f0f0;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
            display: none;
        }

        .upload-progress-bar {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.3s;
        }

        .loading-indicator {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .end-message {
            text-align: center;
            padding: 20px;
            color: #999;
            font-style: italic;
        }

        .size-warning {
            font-size: 0.8rem;
            color: #f44336;
            margin-bottom: 5px;
            padding: 5px;
            background: #ffebee;
            border-radius: 5px;
        }

        .storage-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-storage-compat.js"></script>
</head>
<body>
    <div id="app">
        <div class="alpha-banner">
            ‚ö° –®–µ–¥–µ–≤—Ä–æ–ì—Ä–∞–º–º - SMALLS ‚ö°
        </div>

        <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
        <div id="auth-screen" class="screen active">
            <div class="header">
                <div class="header-left">
                    <div class="header-logo">
                        <img src="https://img.icons8.com/ios7/600/picture.png" alt="logo">
                    </div>
                    <h2>–®–µ–¥–µ–≤—Ä–æ–ì—Ä–∞–º–º</h2>
                </div>
            </div>
            <div class="content">
                <div id="cloud-status" style="text-align: center; margin-bottom: 10px; padding: 8px; border-radius: 5px; background: #4caf50; color: white; font-weight: bold;">
                    ‚úÖ –û–±–ª–∞–∫–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
                </div>
                
                <div class="form-container" id="login-form">
                    <h3 style="color: #667eea; margin-bottom: 20px;">–í—Ö–æ–¥</h3>
                    <div class="form-group">
                        <label>–ù–∏–∫–Ω–µ–π–º</label>
                        <input type="text" id="login-nickname" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å">
                    </div>
                    <button class="btn" onclick="window.login()">–í–æ–π—Ç–∏</button>
                    <p class="switch-text" onclick="window.showRegister()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</p>
                </div>

                <div class="form-container hidden" id="register-form">
                    <h3 style="color: #667eea; margin-bottom: 20px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                    
                    <div class="avatar large" id="register-avatar" onclick="document.getElementById('avatar-input').click()">
                        <span>üì∑</span>
                    </div>
                    <p style="text-align: center; color: #666; font-size: 0.8rem; margin-bottom: 15px;">
                        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∞–≤–∞—Ç–∞—Ä
                    </p>
                    <input type="file" id="avatar-input" accept="image/*" style="display: none;" onchange="window.previewAvatar(this)">
                    
                    <div class="form-group">
                        <label>–ù–∏–∫–Ω–µ–π–º</label>
                        <input type="text" id="register-nickname" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="register-password" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                    <div class="form-group">
                        <label>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</label>
                        <input type="password" id="register-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                    <button class="btn" onclick="window.register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    <p class="switch-text" onclick="window.showLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</p>
                    <div id="register-error" class="error-message"></div>
                </div>
            </div>
        </div>

        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="main-screen" class="screen">
            <div class="header">
                <div class="header-left">
                    <div class="header-logo">
                        <img src="https://img.icons8.com/ios7/600/picture.png" alt="logo">
                    </div>
                    <h2>–®–µ–¥–µ–≤—Ä–æ–ì—Ä–∞–º–º</h2>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="avatar" id="current-user-avatar" onclick="window.openAvatarModal()"></div>
                    <button onclick="window.logout()">üö™</button>
                </div>
            </div>
            <div class="content">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="window.searchUsers()">
                </div>
                
                <div id="search-results" style="margin-bottom: 15px;"></div>
                
                <div class="tabs">
                    <div class="tab active" onclick="window.switchTab('chats')">–ß–∞—Ç—ã</div>
                    <div class="tab" onclick="window.switchTab('groups')">–ì—Ä—É–ø–ø—ã</div>
                    <div class="tab" onclick="window.switchTab('channels')">–ö–∞–Ω–∞–ª—ã</div>
                    <div class="tab" onclick="window.switchTab('strangers')">–ù–µ–∑–Ω–∞–∫–æ–º—Ü—ã</div>
                    <div class="tab" onclick="window.switchTab('smalls')">SMALLS</div>
                    <div class="tab" onclick="window.switchTab('settings')">‚öôÔ∏è</div>
                </div>
                
                <div id="chats-tab" class="tab-content active">
                    <button class="btn btn-secondary" onclick="window.showCreateGroupModal()" style="margin-bottom: 10px;">‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                    <ul class="contacts-list" id="chats-list"></ul>
                </div>
                
                <div id="groups-tab" class="tab-content">
                    <ul class="groups-list" id="groups-list"></ul>
                </div>

                <div id="channels-tab" class="tab-content">
                    <button class="btn btn-secondary" onclick="window.showCreateChannelModal()" style="margin-bottom: 10px;">üì¢ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
                    <ul class="channels-list" id="channels-list"></ul>
                </div>
                
                <div id="strangers-tab" class="tab-content">
                    <ul class="strangers-list" id="strangers-list"></ul>
                </div>

                <div id="smalls-tab" class="tab-content">
                    <button class="btn btn-smalls" onclick="window.showCreateSmallsModal()" style="margin-bottom: 10px;">üé• –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
                    <div class="smalls-feed" id="smalls-feed"></div>
                </div>

                <div id="settings-tab" class="tab-content">
                    <div class="settings-item">
                        <span>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</span>
                        <label class="switch">
                            <input type="checkbox" id="notifications-toggle" onchange="window.toggleNotifications()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <span>üîä –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</span>
                        <label class="switch">
                            <input type="checkbox" id="sound-toggle" onchange="window.toggleSound()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="settings-item" style="justify-content: center;">
                        <button class="btn btn-secondary" onclick="window.requestNotificationPermission()" style="width: auto; padding: 8px 15px; margin: 0;">
                            üîî –†–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        </button>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º -->
                    <div class="settings-item" style="justify-content: center; margin-top: 20px;">
                        <button class="btn btn-danger" onclick="window.clearVideosOnly()" style="width: auto; padding: 8px 15px;">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ SMALLS
                        </button>
                    </div>
                    <div class="settings-item" style="justify-content: center;">
                        <button class="btn btn-secondary" onclick="window.checkStorage()" style="width: auto; padding: 8px 15px;">
                            üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                        </button>
                    </div>
                    <div class="storage-info" id="storage-info"></div>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
        <div id="chat-screen" class="screen">
            <div class="chat-header">
                <button class="back-btn" onclick="window.backToMain()">‚Üê</button>
                <div class="avatar" id="chat-avatar"></div>
                <div class="chat-header-info">
                    <h3 id="chat-with"></h3>
                    <p id="chat-status"></p>
                </div>
                <button class="pin-btn" id="chat-pin-btn" onclick="window.togglePinCurrent()">üìå</button>
            </div>
            <div id="channel-info" class="hidden" style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #eee;">
                <div id="channel-description"></div>
                <div id="channel-subscribers"></div>
            </div>
            <div class="messages" id="messages-container"></div>
            <div class="message-input-area" id="message-input-area">
                <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="window.sendImage()">
                <button class="attach-btn" onclick="document.getElementById('file-input').click()">üìé</button>
                <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') window.sendMessage()">
                <button class="send-btn" onclick="window.sendMessage()">‚û§</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω SMALLS –ø—Ä–æ—Å–º–æ—Ç—Ä -->
        <div id="smalls-view-screen" class="screen">
            <div class="chat-header">
                <button class="back-btn" onclick="window.backToMain()">‚Üê</button>
                <div class="chat-header-info">
                    <h3>SMALLS</h3>
                    <p>–ö–æ—Ä–æ—Ç–∫–∏–µ –≤–∏–¥–µ–æ</p>
                </div>
            </div>
            <div class="smalls-feed" id="smalls-view-feed"></div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div id="profile-screen" class="screen">
            <div class="chat-header">
                <button class="back-btn" onclick="window.backToMain()">‚Üê</button>
                <div class="chat-header-info">
                    <h3 id="profile-username">–ü—Ä–æ—Ñ–∏–ª—å</h3>
                    <p id="profile-chef-count">0 –®–µ–¥–µ–≤—Ä–∏–∫—Å–æ–≤</p>
                </div>
            </div>
            <div class="content">
                <div class="profile-header">
                    <div class="avatar large" id="profile-avatar"></div>
                    <h2 id="profile-name"></h2>
                    <div class="profile-chef-count" id="profile-chef-display">0</div>
                    <div class="profile-chef-label">–®–µ–¥–µ–≤—Ä–∏–∫—Å–æ–≤</div>
                </div>
                <h3 style="color: #667eea; margin: 15px 0;">–í–∏–¥–µ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                <div id="profile-videos"></div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
        <div id="image-modal" class="modal" onclick="this.classList.remove('active')">
            <div class="modal-content">
                <img id="modal-image" src="">
            </div>
        </div>

        <div id="avatar-modal" class="modal">
            <div class="modal-content">
                <h3>–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</h3>
                <div class="avatar large" id="modal-avatar" onclick="document.getElementById('avatar-update-input').click()">
                    <span>üì∑</span>
                </div>
                <input type="file" id="avatar-update-input" accept="image/*" style="display: none;" onchange="window.updateAvatar(this)">
                <button class="btn btn-secondary" onclick="window.closeAvatarModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="group-modal" class="modal">
            <div class="modal-content">
                <h3>–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</h3>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="group-name" maxlength="30">
                </div>
                <div class="form-group">
                    <label>–ê–≤–∞—Ç–∞—Ä</label>
                    <div class="avatar large" id="group-avatar" onclick="document.getElementById('group-avatar-input').click()">
                        <span>üì∑</span>
                    </div>
                    <input type="file" id="group-avatar-input" accept="image/*" style="display: none;" onchange="window.previewGroupAvatar(this)">
                </div>
                <div class="form-group">
                    <label>–£—á–∞—Å—Ç–Ω–∏–∫–∏</label>
                    <div class="members-list" id="group-members-list"></div>
                </div>
                <button class="btn" onclick="window.createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
                <button class="btn btn-secondary" onclick="window.closeGroupModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <div id="channel-modal" class="modal">
            <div class="modal-content">
                <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</h3>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</label>
                    <input type="text" id="channel-name" maxlength="30">
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="channel-description-input" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–∞–Ω–∞–ª"></textarea>
                </div>
                <div class="form-group">
                    <label>–ê–≤–∞—Ç–∞—Ä</label>
                    <div class="avatar large" id="channel-avatar" onclick="document.getElementById('channel-avatar-input').click()">
                        <span>üì∑</span>
                    </div>
                    <input type="file" id="channel-avatar-input" accept="image/*" style="display: none;" onchange="window.previewChannelAvatar(this)">
                </div>
                <button class="btn" onclick="window.createChannel()">–°–æ–∑–¥–∞—Ç—å</button>
                <button class="btn btn-secondary" onclick="window.closeChannelModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <div id="channel-manage-modal" class="modal">
            <div class="modal-content">
                <h3 id="manage-channel-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–º</h3>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="manage-channel-name" maxlength="30">
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="manage-channel-description"></textarea>
                </div>
                <div class="form-group">
                    <label>–ê–≤–∞—Ç–∞—Ä</label>
                    <div class="avatar large" id="manage-channel-avatar" onclick="document.getElementById('manage-channel-avatar-input').click()">
                        <span>üì∑</span>
                    </div>
                    <input type="file" id="manage-channel-avatar-input" accept="image/*" style="display: none;" onchange="window.updateChannelAvatar(this)">
                </div>
                <div class="form-group">
                    <label>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã (–º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å)</label>
                    <div class="subscribers-list" id="channel-admins-list"></div>
                </div>
                <div class="form-group">
                    <label>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</label>
                    <div class="subscribers-list" id="channel-subscribers-list"></div>
                </div>
                <div class="group-actions">
                    <button class="btn" onclick="window.saveChannelSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn btn-danger" onclick="window.deleteChannel()">–£–¥–∞–ª–∏—Ç—å</button>
                    <button class="btn btn-secondary" onclick="window.closeChannelManageModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>

        <div id="group-manage-modal" class="modal">
            <div class="modal-content">
                <h3 id="manage-group-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π</h3>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="manage-group-name" maxlength="30">
                </div>
                <div class="form-group">
                    <label>–ê–≤–∞—Ç–∞—Ä</label>
                    <div class="avatar large" id="manage-group-avatar" onclick="document.getElementById('manage-group-avatar-input').click()">
                        <span>üì∑</span>
                    </div>
                    <input type="file" id="manage-group-avatar-input" accept="image/*" style="display: none;" onchange="window.updateGroupAvatar(this)">
                </div>
                <div class="form-group">
                    <label>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                    <div class="members-list" id="add-members-list"></div>
                </div>
                <div class="form-group">
                    <label>–¢–µ–∫—É—â–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</label>
                    <div class="members-list" id="manage-members-list"></div>
                </div>
                <div class="group-actions">
                    <button class="btn" onclick="window.saveGroupSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn btn-danger" onclick="window.deleteGroup()">–£–¥–∞–ª–∏—Ç—å</button>
                    <button class="btn btn-secondary" onclick="window.closeGroupManageModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>

        <div id="forward-modal" class="modal">
            <div class="modal-content">
                <h3>–ü–µ—Ä–µ—Å–ª–∞—Ç—å</h3>
                <div class="forward-message" id="forward-message-preview"></div>
                <div class="forward-list" id="forward-list"></div>
                <button class="btn" onclick="window.forwardMessage()">–ü–µ—Ä–µ—Å–ª–∞—Ç—å</button>
                <button class="btn btn-secondary" onclick="window.closeForwardModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <div id="confirm-modal" class="modal">
            <div class="modal-content">
                <h3 id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
                <p id="confirm-message"></p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" id="confirm-yes">–î–∞</button>
                    <button class="btn btn-secondary" onclick="window.closeConfirmModal()">–ù–µ—Ç</button>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ -->
        <div id="smalls-modal" class="modal">
            <div class="modal-content">
                <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</h3>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="smalls-title" maxlength="100">
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="smalls-description" maxlength="500"></textarea>
                </div>
                <div class="form-group">
                    <label>–í–∏–¥–µ–æ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ)</label>
                    <div class="size-warning">
                        ‚ö†Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ: <strong>8 –ú–ë</strong>
                    </div>
                    <input type="file" id="smalls-video-input" accept="video/*" onchange="window.previewSmallsVideo(this)">
                </div>
                <div class="upload-progress" id="upload-progress">
                    <div class="upload-progress-bar" id="upload-progress-bar"></div>
                </div>
                <div class="form-group" id="smalls-preview" style="display: none;">
                    <video controls style="width: 100%; max-height: 300px;"></video>
                </div>
                <button class="btn" onclick="window.createSmalls()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                <button class="btn btn-secondary" onclick="window.closeSmallsModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // –°–ù–ê–ß–ê–õ–ê –û–ë–™–Ø–í–õ–Ø–ï–ú –ü–£–°–¢–´–ï –§–£–ù–ö–¶–ò–ò
        // ===========================================
        
        window.login = function() { };
        window.register = function() { };
        window.showRegister = function() { };
        window.showLogin = function() { };
        window.logout = function() { };
        window.switchTab = function(tab) { };
        window.openChat = function(partner, type) { };
        window.togglePin = function(id, type) { };
        window.togglePinCurrent = function() { };
        window.searchUsers = function() { };
        window.addContact = function(username) { };
        window.sendMessage = function() { };
        window.sendImage = function() { };
        window.backToMain = function() { };
        window.openImageModal = function(src) { };
        window.openAvatarModal = function() { };
        window.closeAvatarModal = function() { };
        window.updateAvatar = function(input) { };
        window.previewAvatar = function(input) { };
        window.previewGroupAvatar = function(input) { };
        window.previewChannelAvatar = function(input) { };
        window.showCreateGroupModal = function() { };
        window.closeGroupModal = function() { };
        window.createGroup = function() { };
        window.openGroupManage = function(id) { };
        window.closeGroupManageModal = function() { };
        window.updateGroupAvatar = function(input) { };
        window.toggleAdmin = function(groupId, member) { };
        window.saveGroupSettings = function() { };
        window.deleteGroup = function() { };
        window.showCreateChannelModal = function() { };
        window.closeChannelModal = function() { };
        window.createChannel = function() { };
        window.subscribeToChannel = function(channelId) { };
        window.openChannelManage = function(id) { };
        window.closeChannelManageModal = function() { };
        window.updateChannelAvatar = function(input) { };
        window.toggleChannelAdmin = function(channelId, member) { };
        window.saveChannelSettings = function() { };
        window.deleteChannel = function() { };
        window.requestNotificationPermission = function() { };
        window.toggleNotifications = function() { };
        window.toggleSound = function() { };
        window.showForwardModal = function(data) { };
        window.selectForwardTarget = function(id, type) { };
        window.forwardMessage = function() { };
        window.closeForwardModal = function() { };
        window.closeConfirmModal = function() { };
        window.deleteMessage = function(index) { };
        
        // SMALLS —Ñ—É–Ω–∫—Ü–∏–∏
        window.showCreateSmallsModal = function() { };
        window.closeSmallsModal = function() { };
        window.previewSmallsVideo = function(input) { };
        window.createSmalls = function() { };
        window.loadSmalls = function() { };
        window.openProfile = function(username) { };
        window.toggleChef = function(videoId) { };
        window.addComment = function(videoId) { };
        
        // –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
        window.clearVideosOnly = function() { };
        window.checkStorage = function() { };

        // ===========================================
        // –¢–ï–ü–ï–†–¨ –û–°–ù–û–í–ù–û–ô –ö–û–î
        // ===========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyB_TejaNCZDMwZQjlMLv9zvwX2vYUcKcLQ",
            authDomain: "shedevrogramm.firebaseapp.com",
            projectId: "shedevrogramm",
            storageBucket: "shedevrogramm.firebasestorage.app",
            messagingSenderId: "481298226461",
            appId: "1:481298226461:web:628f47dfde74bfc40455f4"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        db.settings({ 
            cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED 
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let users = [];
        let userData = {};
        let currentUser = null;
        let messages = {};
        let contacts = {};
        let strangers = {};
        let groups = {};
        let channels = {};
        let smalls = [];
        let pinned = { chats: [], groups: [], channels: [] };
        let readReceipts = {};
        let settings = {
            notifications: false,
            sound: false
        };
        
        let currentChatPartner = null;
        let currentChatType = 'private';
        let messageToForward = null;
        let selectedForwardTarget = null;
        let selectedForwardType = null;
        let confirmCallback = null;
        let currentSmallsVideo = null;

        // ===========================================
        // –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ë–ï–°–ö–û–ù–ï–ß–ù–û–ô –õ–ï–ù–¢–´
        // ===========================================
        
        let allSmalls = []; // –í—Å–µ –≤–∏–¥–µ–æ
        let displayedSmalls = 0; // –°–∫–æ–ª—å–∫–æ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ
        const SMALLS_PER_PAGE = 5; // –°–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∑–∞ —Ä–∞–∑
        let isLoading = false; // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
        let hasMore = true; // –ï—Å—Ç—å –ª–∏ –µ—â–µ –≤–∏–¥–µ–æ

        // ===========================================
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–•
        // ===========================================
        
        function loadLocalData() {
            try {
                users = JSON.parse(localStorage.getItem('sg_users')) || [];
                userData = JSON.parse(localStorage.getItem('sg_userData')) || {};
                currentUser = localStorage.getItem('sg_currentUser') || null;
                messages = JSON.parse(localStorage.getItem('sg_messages')) || {};
                contacts = JSON.parse(localStorage.getItem('sg_contacts')) || {};
                strangers = JSON.parse(localStorage.getItem('sg_strangers')) || {};
                groups = JSON.parse(localStorage.getItem('sg_groups')) || {};
                channels = JSON.parse(localStorage.getItem('sg_channels')) || {};
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                const savedSmalls = localStorage.getItem('sg_smalls');
                if (savedSmalls) {
                    try {
                        smalls = JSON.parse(savedSmalls) || [];
                        // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –≤–∏–¥–µ–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
                        if (smalls.length > 10) {
                            smalls = smalls.slice(0, 10);
                        }
                        allSmalls = [...smalls];
                    } catch (e) {
                        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã, –æ—á–∏—â–∞–µ–º
                        smalls = [];
                        allSmalls = [];
                        localStorage.removeItem('sg_smalls');
                    }
                } else {
                    smalls = [];
                    allSmalls = [];
                }
                
                pinned = JSON.parse(localStorage.getItem('sg_pinned')) || { chats: [], groups: [], channels: [] };
                readReceipts = JSON.parse(localStorage.getItem('sg_readReceipts')) || {};
                const savedSettings = JSON.parse(localStorage.getItem('sg_settings'));
                if (savedSettings) {
                    settings = savedSettings;
                }
            } catch (e) {
                console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è');
                users = [];
                userData = {};
                currentUser = null;
                messages = {};
                contacts = {};
                strangers = {};
                groups = {};
                channels = {};
                smalls = [];
                allSmalls = [];
            }
        }

        function saveLocalData() {
            try {
                localStorage.setItem('sg_users', JSON.stringify(users));
                localStorage.setItem('sg_userData', JSON.stringify(userData));
                if (currentUser) localStorage.setItem('sg_currentUser', currentUser);
                localStorage.setItem('sg_messages', JSON.stringify(messages));
                localStorage.setItem('sg_contacts', JSON.stringify(contacts));
                localStorage.setItem('sg_strangers', JSON.stringify(strangers));
                localStorage.setItem('sg_groups', JSON.stringify(groups));
                localStorage.setItem('sg_channels', JSON.stringify(channels));
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏–¥–µ–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Ö –Ω–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ
                if (smalls.length > 0) {
                    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –≤–∏–¥–µ–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
                    const recentSmalls = smalls.slice(0, 10);
                    localStorage.setItem('sg_smalls', JSON.stringify(recentSmalls));
                } else {
                    localStorage.removeItem('sg_smalls');
                }
                
                localStorage.setItem('sg_pinned', JSON.stringify(pinned));
                localStorage.setItem('sg_readReceipts', JSON.stringify(readReceipts));
                localStorage.setItem('sg_settings', JSON.stringify(settings));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                updateStorageInfo();
                
            } catch (e) {
                console.log('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', e);
                if (e.name === 'QuotaExceededError') {
                    showNotification('‚ö†Ô∏è –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–æ. –û—á–∏—Å—Ç–∏—Ç–µ –≤–∏–¥–µ–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.', 'error');
                    
                    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≤–∏–¥–µ–æ
                    if (smalls.length > 5) {
                        smalls = smalls.slice(0, 5);
                        allSmalls = [...smalls];
                        try {
                            localStorage.setItem('sg_smalls', JSON.stringify(smalls));
                        } catch (e2) {
                            // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –æ—à–∏–±–∫–∞, —É–¥–∞–ª—è–µ–º –≤—Å–µ –≤–∏–¥–µ–æ
                            smalls = [];
                            allSmalls = [];
                            localStorage.removeItem('sg_smalls');
                        }
                    }
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        function updateStorageInfo() {
            const storageInfo = document.getElementById('storage-info');
            if (!storageInfo) return;
            
            let total = 0;
            let videoCount = smalls.length;
            
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length * 2 / 1024 / 1024;
                }
            }
            
            storageInfo.innerHTML = `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${total.toFixed(2)} –ú–ë | –í–∏–¥–µ–æ: ${videoCount}`;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ
        window.clearVideosOnly = function() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤–∏–¥–µ–æ –∏–∑ SMALLS? –°–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è.')) {
                smalls = [];
                allSmalls = [];
                localStorage.removeItem('sg_smalls');
                showNotification('‚úÖ –í–∏–¥–µ–æ —É–¥–∞–ª–µ–Ω—ã', 'success');
                loadSmalls(true);
                updateStorageInfo();
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        window.checkStorage = function() {
            let total = 0;
            let details = [];
            
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    let size = localStorage[key].length * 2 / 1024 / 1024;
                    total += size;
                    if (key === 'sg_smalls') {
                        details.push(`üìπ –í–∏–¥–µ–æ: ${size.toFixed(2)} –ú–ë`);
                    } else {
                        details.push(`${key}: ${size.toFixed(2)} –ú–ë`);
                    }
                }
            }
            
            let message = `–í—Å–µ–≥–æ: ${total.toFixed(2)} –ú–ë\n`;
            message += details.join('\n');
            alert(message);
            updateStorageInfo();
        };

        loadLocalData();

        async function loadFirebaseData() {
            try {
                const doc = await db.collection('data').doc('main').get();
                if (doc.exists) {
                    const data = doc.data();
                    users = data.users || users;
                    userData = data.userData || userData;
                    messages = data.messages || messages;
                    contacts = data.contacts || contacts;
                    strangers = data.strangers || strangers;
                    groups = data.groups || groups;
                    channels = data.channels || channels;
                    
                    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤–∏–¥–µ–æ –∏–∑ Firebase –∏ localStorage
                    const firebaseSmalls = data.smalls || [];
                    const localSmalls = smalls || [];
                    
                    const allVideos = [...firebaseSmalls, ...localSmalls];
                    
                    // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ id
                    const seen = new Set();
                    allSmalls = [];
                    
                    allVideos.forEach(video => {
                        if (!seen.has(video.id)) {
                            seen.add(video.id);
                            allSmalls.push(video);
                        }
                    });
                    
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                    allSmalls.sort((a, b) => {
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    });
                    
                    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –≤–∏–¥–µ–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
                    if (allSmalls.length > 20) {
                        allSmalls = allSmalls.slice(0, 20);
                    }
                    
                    smalls = allSmalls;
                    
                    pinned = data.pinned || pinned;
                    readReceipts = data.readReceipts || readReceipts;
                    settings = data.settings || settings;
                    
                    saveLocalData();
                    
                    const cloudStatus = document.getElementById('cloud-status');
                    if (cloudStatus) {
                        cloudStatus.innerHTML = '‚úÖ –û–±–ª–∞–∫–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
                    }
                    
                    if (currentUser && document.getElementById('main-screen').classList.contains('active')) {
                        loadMainScreen();
                    }
                }
            } catch (e) {
                const cloudStatus = document.getElementById('cloud-status');
                if (cloudStatus) {
                    cloudStatus.innerHTML = '‚ö†Ô∏è –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º';
                }
            }
        }

        async function saveFirebaseData() {
            try {
                await db.collection('data').doc('main').set({
                    users, userData, messages, contacts, strangers, groups, channels, smalls, pinned, readReceipts, settings,
                    lastUpdate: new Date().toISOString()
                });
            } catch (e) {
                console.log('Firebase save error');
            }
        }

        async function saveAllData() {
            saveLocalData();
            await saveFirebaseData();
        }

        setTimeout(loadFirebaseData, 1000);

        // ===========================================
        // –§–£–ù–ö–¶–ò–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
        // ===========================================
        
        window.requestNotificationPermission = function() {
            if (!("Notification" in window)) {
                showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
                return;
            }
            
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    settings.notifications = true;
                    const notifToggle = document.getElementById('notifications-toggle');
                    if (notifToggle) notifToggle.checked = true;
                    saveAllData();
                    showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –≤–∫–ª—é—á–µ–Ω—ã!', 'success');
                }
            });
        };

        window.toggleNotifications = function() {
            const enabled = document.getElementById('notifications-toggle').checked;
            settings.notifications = enabled;
            
            if (enabled && Notification.permission !== 'granted') {
                window.requestNotificationPermission();
            }
            
            saveAllData();
            showNotification(enabled ? '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã' : '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã', 'info');
        };

        window.toggleSound = function() {
            settings.sound = document.getElementById('sound-toggle').checked;
            saveAllData();
            showNotification(settings.sound ? '–ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω' : '–ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω', 'info');
        };

        function sendMessageNotification(title, body) {
            if (!settings.notifications || Notification.permission !== 'granted') return;
            
            try {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://img.icons8.com/ios7/600/picture.png',
                    badge: 'https://img.icons8.com/ios7/600/picture.png',
                    tag: 'shedevrogramm'
                });
                
                if (settings.sound) {
                    const audio = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3');
                    audio.play().catch(() => {});
                }
                
                setTimeout(() => notification.close(), 5000);
            } catch (e) {
                console.log('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
            }
        }

        // ===========================================
        // –§–£–ù–ö–¶–ò–ò –≠–ö–†–ê–ù–û–í
        // ===========================================
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        window.showRegister = function() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('register-error').textContent = '';
        };

        window.showLogin = function() {
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-error').textContent = '';
        };

        window.previewAvatar = function(input) {
            if (input.files?.[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('register-avatar').style.backgroundImage = `url('${e.target.result}')`;
                    document.getElementById('register-avatar').style.backgroundSize = 'cover';
                    document.getElementById('register-avatar').innerHTML = '';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.register = async function() {
            const nickname = document.getElementById('register-nickname').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const confirm = document.getElementById('register-confirm').value.trim();
            
            if (!nickname || !password || !confirm) {
                document.getElementById('register-error').textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                return;
            }

            if (password !== confirm) {
                document.getElementById('register-error').textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                return;
            }

            if (users.includes(nickname)) {
                document.getElementById('register-error').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
                return;
            }

            let avatar = '';
            const avatarEl = document.getElementById('register-avatar');
            if (avatarEl.style.backgroundImage) {
                avatar = avatarEl.style.backgroundImage.replace(/url\(["']?|["']?\)/g, '');
            }

            users.push(nickname);
            userData[nickname] = { password, avatar, chefCount: 0 };
            currentUser = nickname;

            await saveAllData();
            showScreen('main-screen');
            loadMainScreen();
            showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
        };

        window.login = async function() {
            const nickname = document.getElementById('login-nickname').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!nickname || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            if (!users.includes(nickname)) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            if (userData[nickname]?.password !== password) {
                showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }

            currentUser = nickname;
            await saveAllData();
            showScreen('main-screen');
            loadMainScreen();
            showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
        };

        window.logout = function() {
            currentUser = null;
            saveLocalData();
            showScreen('auth-screen');
        };

        // ===========================================
        // –§–£–ù–ö–¶–ò–ò –ì–õ–ê–í–ù–û–ì–û –≠–ö–†–ê–ù–ê
        // ===========================================
        
        function loadMainScreen() {
            updateUserAvatar();
            loadChats();
            loadGroups();
            loadChannels();
            loadStrangers();
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = '';
            
            const notifToggle = document.getElementById('notifications-toggle');
            const soundToggle = document.getElementById('sound-toggle');
            if (notifToggle) notifToggle.checked = settings.notifications;
            if (soundToggle) soundToggle.checked = settings.sound;
            
            updateStorageInfo();
        }

        function updateUserAvatar() {
            const avatarEl = document.getElementById('current-user-avatar');
            if (userData[currentUser]?.avatar) {
                avatarEl.style.backgroundImage = `url('${userData[currentUser].avatar}')`;
                avatarEl.style.backgroundSize = 'cover';
                avatarEl.innerHTML = '';
            } else {
                avatarEl.style.backgroundImage = 'none';
                avatarEl.innerHTML = currentUser ? currentUser[0].toUpperCase() : '?';
            }
        }

        window.switchTab = function(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'chats') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('chats-tab').classList.add('active');
                loadChats();
            } else if (tab === 'groups') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('groups-tab').classList.add('active');
                loadGroups();
            } else if (tab === 'channels') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('channels-tab').classList.add('active');
                loadChannels();
            } else if (tab === 'strangers') {
                document.querySelectorAll('.tab')[3].classList.add('active');
                document.getElementById('strangers-tab').classList.add('active');
                loadStrangers();
            } else if (tab === 'smalls') {
                document.querySelectorAll('.tab')[4].classList.add('active');
                document.getElementById('smalls-tab').classList.add('active');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –ª–µ–Ω—Ç—É SMALLS
                displayedSmalls = 0;
                hasMore = true;
                loadSmalls(true);
            } else if (tab === 'settings') {
                document.querySelectorAll('.tab')[5].classList.add('active');
                document.getElementById('settings-tab').classList.add('active');
                updateStorageInfo();
            }
        };

        // ===========================================
        // –§–£–ù–ö–¶–ò–ò –ß–ê–¢–û–í
        // ===========================================
        
        function getUnreadCount(chatId) {
            if (!currentUser || !readReceipts[currentUser] || !readReceipts[currentUser][chatId]) return 0;
            
            const lastReadIndex = readReceipts[currentUser][chatId] || -1;
            const messages_list = (messages[currentUser] && messages[currentUser][chatId]) ? messages[currentUser][chatId] : [];
            
            return messages_list.filter((msg, index) => 
                msg && msg.sender !== currentUser && !msg.deleted && index > lastReadIndex
            ).length;
        }

        function loadChats() {
            const chatsList = document.getElementById('chats-list');
            if (!chatsList) return;
            
            if (!currentUser) {
                chatsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">üì≠ –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</p>';
                return;
            }
            
            const userContacts = contacts[currentUser] || [];
            
            if (userContacts.length === 0) {
                chatsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">üì≠ –ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>';
                return;
            }

            const pinnedChats = userContacts.filter(c => pinned.chats && pinned.chats.includes(c));
            const regularChats = userContacts.filter(c => !pinned.chats || !pinned.chats.includes(c));

            let html = '';

            pinnedChats.forEach(contact => {
                html += renderChatItem(contact, true);
            });

            regularChats.forEach(contact => {
                html += renderChatItem(contact, false);
            });

            chatsList.innerHTML = html;
        }

        function renderChatItem(contact, isPinned) {
            const avatarStyle = userData[contact]?.avatar ? 
                `background-image: url('${userData[contact].avatar}'); background-size: cover;` : 
                'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
            
            const chatId = [currentUser, contact].sort().join('_');
            const unreadCount = getUnreadCount(chatId);
            
            return `
                <li class="contact-item ${isPinned ? 'pinned' : ''}">
                    <div class="contact-info" onclick="window.openChat('${contact}', 'private')">
                        <div class="avatar small" style="${avatarStyle}"></div>
                        <div>
                            <h4>
                                ${contact} ${isPinned ? '<span class="pin-badge">üìå</span>' : ''}
                                ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                            </h4>
                            <p>${getLastMessagePreview(contact)}</p>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="pin-btn" onclick="window.togglePin('${contact}', 'chat'); event.stopPropagation();">
                            ${isPinned ? 'üìå' : 'üìç'}
                        </button>
                    </div>
                </li>
            `;
        }

        function loadGroups() {
            const groupsList = document.getElementById('groups-list');
            if (!groupsList) return;
            
            if (!currentUser) {
                groupsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">üë• –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</p>';
                return;
            }
            
            const userGroups = groups[currentUser] || [];
            
            if (userGroups.length === 0) {
                groupsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">üë• –ù–µ—Ç –≥—Ä—É–ø–ø</p>';
                return;
            }

            const pinnedGroups = userGroups.filter(g => pinned.groups && pinned.groups.includes(g));
            const regularGroups = userGroups.filter(g => !pinned.groups || !pinned.groups.includes(g));

            let html = '';

            pinnedGroups.forEach(groupId => {
                html += renderGroupItem(groupId, true);
            });

            regularGroups.forEach(groupId => {
                html += renderGroupItem(groupId, false);
            });

            groupsList.innerHTML = html;
        }

        function renderGroupItem(groupId, isPinned) {
            const group = groups[groupId];
            if (!group) return '';

            const isAdmin = group.admins && group.admins.includes(currentUser);
            const avatarStyle = group.avatar ? 
                `background-image: url('${group.avatar}'); background-size: cover;` : 
                'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';

            const unreadCount = getUnreadCount(groupId);

            return `
                <li class="group-item ${isPinned ? 'pinned' : ''}">
                    <div class="contact-info" onclick="window.openChat('${groupId}', 'group')">
                        <div class="avatar small" style="${avatarStyle}"></div>
                        <div>
                            <h4>
                                ${escapeHtml(group.name)} ${isPinned ? '<span class="pin-badge">üìå</span>' : ''}
                                ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                            </h4>
                            <p>${group.members ? group.members.length : 0} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                        </div>
                    </div>
                    <div class="chat-actions">
                        ${isAdmin ? `
                            <button class="chat-btn" onclick="window.openGroupManage('${groupId}'); event.stopPropagation();">‚öôÔ∏è</button>
                        ` : ''}
                        <button class="pin-btn" onclick="window.togglePin('${groupId}', 'group'); event.stopPropagation();">
                            ${isPinned ? 'üìå' : 'üìç'}
                        </button>
                    </div>
                </li>
            `;
        }

        function loadChannels() {
            const channelsList = document.getElementById('channels-list');
            if (!channelsList) return;
            
            if (!currentUser) {
                channelsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">üì¢ –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</p>';
                return;
            }
            
            const userChannels = [];
            
            for (let channelId in channels) {
                const channel = channels[channelId];
                if (channel && channel.subscribers && channel.subscribers.includes(currentUser)) {
                    userChannels.push(channelId);
                } else if (channel && channel.owner === currentUser) {
                    userChannels.push(channelId);
                }
            }
            
            if (userChannels.length === 0) {
                channelsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">üì¢ –ù–µ—Ç –∫–∞–Ω–∞–ª–æ–≤</p>';
                return;
            }

            const pinnedChannels = userChannels.filter(c => pinned.channels && pinned.channels.includes(c));
            const regularChannels = userChannels.filter(c => !pinned.channels || !pinned.channels.includes(c));

            let html = '';

            pinnedChannels.forEach(channelId => {
                html += renderChannelItem(channelId, true);
            });

            regularChannels.forEach(channelId => {
                html += renderChannelItem(channelId, false);
            });

            channelsList.innerHTML = html;
        }

        function renderChannelItem(channelId, isPinned) {
            const channel = channels[channelId];
            if (!channel) return '';

            const isOwner = channel.owner === currentUser;
            const isAdmin = channel.admins && channel.admins.includes(currentUser);
            const avatarStyle = channel.avatar ? 
                `background-image: url('${channel.avatar}'); background-size: cover;` : 
                'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';

            const unreadCount = getUnreadCount(channelId);

            return `
                <li class="channel-item ${isPinned ? 'pinned' : ''}">
                    <div class="contact-info" onclick="window.openChat('${channelId}', 'channel')">
                        <div class="avatar small" style="${avatarStyle}"></div>
                        <div>
                            <h4>
                                ${escapeHtml(channel.name)} 
                                <span class="subscriber-badge">${channel.subscribers ? channel.subscribers.length : 0}</span>
                                ${isPinned ? '<span class="pin-badge">üìå</span>' : ''}
                                ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                            </h4>
                            <p>${channel.description ? channel.description.substring(0, 30) : '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}${channel.description && channel.description.length > 30 ? '...' : ''}</p>
                        </div>
                    </div>
                    <div class="chat-actions">
                        ${(!channel.subscribers || !channel.subscribers.includes(currentUser)) && channel.owner !== currentUser ? `
                            <button class="subscribe-btn" onclick="window.subscribeToChannel('${channelId}'); event.stopPropagation();">üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                        ` : ''}
                        ${isOwner || isAdmin ? `
                            <button class="chat-btn" onclick="window.openChannelManage('${channelId}'); event.stopPropagation();">‚öôÔ∏è</button>
                        ` : ''}
                        <button class="pin-btn" onclick="window.togglePin('${channelId}', 'channel'); event.stopPropagation();">
                            ${isPinned ? 'üìå' : 'üìç'}
                        </button>
                    </div>
                </li>
            `;
        }

        function loadStrangers() {
            const strangersList = document.getElementById('strangers-list');
            if (!strangersList) return;
            
            if (!currentUser) {
                strangersList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">üë§ –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</p>';
                return;
            }
            
            const userStrangers = strangers[currentUser] || [];
            
            const filteredStrangers = userStrangers.filter(s => !(contacts[currentUser] || []).includes(s));
            
            if (filteredStrangers.length === 0) {
                strangersList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">üë§ –ù–µ—Ç –Ω–µ–∑–Ω–∞–∫–æ–º—Ü–µ–≤</p>';
                return;
            }

            strangersList.innerHTML = filteredStrangers.map(stranger => {
                const avatarStyle = userData[stranger]?.avatar ? 
                    `background-image: url('${userData[stranger].avatar}'); background-size: cover;` : 
                    'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
                
                const chatId = [currentUser, stranger].sort().join('_');
                const unreadCount = getUnreadCount(chatId);
                
                return `
                    <li class="stranger-item">
                        <div class="contact-info">
                            <div class="avatar small" style="${avatarStyle}"></div>
                            <div>
                                <h4>
                                    ${stranger}
                                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                                </h4>
                                <p>${getLastMessagePreview(stranger)}</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="add-btn" onclick="window.addContact('${stranger}')">‚ûï</button>
                            <button class="chat-btn" onclick="window.openChat('${stranger}', 'private')">üí¨</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        window.searchUsers = function() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            const searchResults = document.getElementById('search-results');
            
            if (!query || !currentUser) {
                searchResults.innerHTML = '';
                return;
            }

            const userContacts = contacts[currentUser] || [];
            
            const userResults = users.filter(user => 
                user && user.toLowerCase().includes(query) && 
                user !== currentUser
            );

            const channelResults = [];
            for (let channelId in channels) {
                const channel = channels[channelId];
                if (channel && channel.name && channel.name.toLowerCase().includes(query) && 
                    (!channel.subscribers || !channel.subscribers.includes(currentUser)) && 
                    channel.owner !== currentUser) {
                    channelResults.push({ id: channelId, ...channel });
                }
            }

            if (userResults.length === 0 && channelResults.length === 0) {
                searchResults.innerHTML = '<p style="color: #666; text-align: center; padding: 10px;">üòï –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                return;
            }

            let html = '<h4 style="color: #667eea; margin: 10px 0;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h4>';

            userResults.forEach(user => {
                const isContact = userContacts.includes(user);
                const avatarStyle = userData[user]?.avatar ? 
                    `background-image: url('${userData[user].avatar}'); background-size: cover;` : 
                    'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
                
                html += `
                    <div style="background:white; padding:15px; margin-bottom:8px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="avatar small" style="${avatarStyle}"></div>
                            <h4>${user}</h4>
                        </div>
                        ${!isContact ? 
                            `<button onclick="window.addContact('${user}')" style="background:#667eea; color:white; border:none; padding:8px 15px; border-radius:20px; cursor:pointer;">–î–æ–±–∞–≤–∏—Ç—å</button>` : 
                            `<span style="color: #4caf50;">‚úì</span>`}
                    </div>
                `;
            });

            channelResults.forEach(channel => {
                const avatarStyle = channel.avatar ? 
                    `background-image: url('${channel.avatar}'); background-size: cover;` : 
                    'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
                
                html += `
                    <div style="background:white; padding:15px; margin-bottom:8px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px; flex:1;" onclick="window.openChat('${channel.id}', 'channel')">
                            <div class="avatar small" style="${avatarStyle}"></div>
                            <div>
                                <h4>${escapeHtml(channel.name)} <span class="subscriber-badge">${channel.subscribers ? channel.subscribers.length : 0}</span></h4>
                                <p style="font-size:0.8rem; color:#666;">${channel.description ? channel.description.substring(0, 30) : '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                            </div>
                        </div>
                        <button class="subscribe-btn" onclick="window.subscribeToChannel('${channel.id}')" style="margin-left:10px;">
                            üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
                        </button>
                    </div>
                `;
            });

            searchResults.innerHTML = html;
        };

        window.addContact = async function(username) {
            if (!currentUser) return;
            
            if (!contacts[currentUser]) contacts[currentUser] = [];
            
            if (!contacts[currentUser].includes(username)) {
                contacts[currentUser].push(username);
                await saveAllData();
                
                if (strangers[currentUser]) {
                    strangers[currentUser] = strangers[currentUser].filter(s => s !== username);
                    await saveAllData();
                }
                
                loadChats();
                loadStrangers();
                document.getElementById('search-input').value = '';
                document.getElementById('search-results').innerHTML = '';
                showNotification('–î–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ç–∞–∫—Ç—ã');
            }
        };

        window.togglePin = async function(id, type) {
            if (!currentUser) return;
            
            if (type === 'chat') {
                if (!pinned.chats) pinned.chats = [];
                if (pinned.chats.includes(id)) {
                    pinned.chats = pinned.chats.filter(c => c !== id);
                } else {
                    pinned.chats.push(id);
                }
            } else if (type === 'group') {
                if (!pinned.groups) pinned.groups = [];
                if (pinned.groups.includes(id)) {
                    pinned.groups = pinned.groups.filter(g => g !== id);
                } else {
                    pinned.groups.push(id);
                }
            } else if (type === 'channel') {
                if (!pinned.channels) pinned.channels = [];
                if (pinned.channels.includes(id)) {
                    pinned.channels = pinned.channels.filter(c => c !== id);
                } else {
                    pinned.channels.push(id);
                }
            }
            await saveAllData();
            loadChats();
            loadGroups();
            loadChannels();
        };

        window.togglePinCurrent = function() {
            if (!currentUser || !currentChatPartner) return;
            
            if (currentChatType === 'private') {
                window.togglePin(currentChatPartner, 'chat');
            } else if (currentChatType === 'group') {
                window.togglePin(currentChatPartner, 'group');
            } else if (currentChatType === 'channel') {
                window.togglePin(currentChatPartner, 'channel');
            }
        };

        window.openChat = function(partner, type) {
            if (!currentUser) return;
            
            currentChatPartner = partner;
            currentChatType = type;
            
            const isChannel = type === 'channel';
            const channel = isChannel ? channels[partner] : null;
            
            if (type === 'private') {
                document.getElementById('chat-with').textContent = partner;
                document.getElementById('chat-status').textContent = '–ª–∏—á–Ω—ã–π —á–∞—Ç';
                
                const avatarEl = document.getElementById('chat-avatar');
                if (userData[partner]?.avatar) {
                    avatarEl.style.backgroundImage = `url('${userData[partner].avatar}')`;
                    avatarEl.style.backgroundSize = 'cover';
                    avatarEl.innerHTML = '';
                } else {
                    avatarEl.style.backgroundImage = 'none';
                    avatarEl.innerHTML = partner ? partner[0].toUpperCase() : '?';
                }
                
                document.getElementById('channel-info').classList.add('hidden');
                document.getElementById('message-input-area').classList.remove('hidden');
            } else if (type === 'group') {
                const group = groups[partner];
                if (!group) return;
                document.getElementById('chat-with').textContent = group.name || '–ì—Ä—É–ø–ø–∞';
                document.getElementById('chat-status').textContent = group.members ? `${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤` : '0 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤';
                
                const avatarEl = document.getElementById('chat-avatar');
                if (group.avatar) {
                    avatarEl.style.backgroundImage = `url('${group.avatar}')`;
                    avatarEl.style.backgroundSize = 'cover';
                    avatarEl.innerHTML = '';
                } else {
                    avatarEl.style.backgroundImage = 'none';
                    avatarEl.innerHTML = group.name ? group.name[0].toUpperCase() : 'G';
                }
                
                document.getElementById('channel-info').classList.add('hidden');
                document.getElementById('message-input-area').classList.remove('hidden');
            } else if (type === 'channel') {
                if (!channel) return;
                document.getElementById('chat-with').textContent = channel.name || '–ö–∞–Ω–∞–ª';
                document.getElementById('chat-status').textContent = channel.subscribers ? `${channel.subscribers.length} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤` : '0 –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤';
                
                const avatarEl = document.getElementById('chat-avatar');
                if (channel.avatar) {
                    avatarEl.style.backgroundImage = `url('${channel.avatar}')`;
                    avatarEl.style.backgroundSize = 'cover';
                    avatarEl.innerHTML = '';
                } else {
                    avatarEl.style.backgroundImage = 'none';
                    avatarEl.innerHTML = channel.name ? channel.name[0].toUpperCase() : 'C';
                }
                
                const channelInfo = document.getElementById('channel-info');
                const channelDesc = document.getElementById('channel-description');
                const channelSubs = document.getElementById('channel-subscribers');
                
                channelDesc.innerHTML = channel.description ? 
                    `<strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${escapeHtml(channel.description)}` : 
                    '<strong>–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</strong>';
                channelSubs.innerHTML = `<strong>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏:</strong> ${channel.subscribers ? channel.subscribers.length : 0}`;
                
                channelInfo.classList.remove('hidden');
                
                const canWrite = channel.owner === currentUser || (channel.admins && channel.admins.includes(currentUser));
                if (!canWrite) {
                    document.getElementById('message-input-area').classList.add('hidden');
                } else {
                    document.getElementById('message-input-area').classList.remove('hidden');
                }
            }
            
            markMessagesAsRead();
            loadMessages();
            showScreen('chat-screen');
        };

        async function markMessagesAsRead() {
            if (!currentUser || !currentChatPartner) return;
            
            const chatId = currentChatType === 'private' 
                ? [currentUser, currentChatPartner].sort().join('_')
                : currentChatPartner;
            
            if (!readReceipts[currentUser]) readReceipts[currentUser] = {};
            
            const messages_list = (messages[currentUser] && messages[currentUser][chatId]) ? messages[currentUser][chatId] : [];
            readReceipts[currentUser][chatId] = messages_list.length - 1;
            
            await saveAllData();
            
            if (document.getElementById('main-screen').classList.contains('active')) {
                loadChats();
                loadGroups();
                loadChannels();
                loadStrangers();
            }
        }

        function linkify(text) {
            if (!text) return text;
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url => {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            });
        }

        function loadMessages() {
            const container = document.getElementById('messages-container');
            if (!container) return;
            
            let chatMessages = [];
            
            if (!currentUser || !currentChatPartner) {
                container.innerHTML = '';
                return;
            }
            
            if (currentChatType === 'private') {
                const chatId = [currentUser, currentChatPartner].sort().join('_');
                chatMessages = (messages[currentUser] && messages[currentUser][chatId]) ? messages[currentUser][chatId] : [];
            } else {
                chatMessages = (messages[currentUser] && messages[currentUser][currentChatPartner]) ? messages[currentUser][currentChatPartner] : [];
            }
            
            container.innerHTML = chatMessages.map((msg, index) => {
                if (!msg) return '';
                
                if (msg.deleted) {
                    return `
                        <div class="message received deleted">
                            <small>${msg.time || ''}</small>
                        </div>
                    `;
                }
                
                const cls = `message ${msg.sender === currentUser ? 'sent' : 'received'} ${msg.forwarded ? 'fwd' : ''}`;
                const sender = (currentChatType === 'group' || currentChatType === 'channel' || msg.sender !== currentUser) ? 
                    `<div class="message-sender">${escapeHtml(msg.sender || '')}</div>` : '';
                
                const canDelete = msg.sender === currentUser || 
                    (currentChatType === 'group' && groups[currentChatPartner] && groups[currentChatPartner].admins && groups[currentChatPartner].admins.includes(currentUser)) ||
                    (currentChatType === 'channel' && channels[currentChatPartner] && (channels[currentChatPartner].owner === currentUser || (channels[currentChatPartner].admins && channels[currentChatPartner].admins.includes(currentUser))));
                
                if (msg.type === 'text') {
                    return `
                        <div class="${cls}">
                            ${sender}
                            ${linkify(escapeHtml(msg.text || ''))}
                            <small>${msg.time || ''}</small>
                            <div class="message-actions">
                                ${canDelete ? `
                                    <button class="delete-btn" onclick="window.deleteMessage(${index})">üóëÔ∏è</button>
                                ` : ''}
                                <button class="forward-btn" onclick="window.showForwardModal('${encodeURIComponent(JSON.stringify(msg))}')">‚Ü™Ô∏è</button>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="${cls}">
                            ${sender}
                            <img src="${msg.content || ''}" onclick="window.openImageModal('${msg.content || ''}')">
                            <small>${msg.time || ''}</small>
                            <div class="message-actions">
                                ${canDelete ? `
                                    <button class="delete-btn" onclick="window.deleteMessage(${index})">üóëÔ∏è</button>
                                ` : ''}
                                <button class="forward-btn" onclick="window.showForwardModal('${encodeURIComponent(JSON.stringify(msg))}')">‚Ü™Ô∏è</button>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        window.deleteMessage = async function(index) {
            if (!currentUser || !currentChatPartner) return;
            
            const chatId = currentChatType === 'private' 
                ? [currentUser, currentChatPartner].sort().join('_')
                : currentChatPartner;
            
            const usersToUpdate = currentChatType === 'private' 
                ? [currentUser, currentChatPartner]
                : (currentChatType === 'group' ? (groups[currentChatPartner] ? groups[currentChatPartner].members || [] : []) : (channels[currentChatPartner] ? channels[currentChatPartner].subscribers || [] : []));
            
            usersToUpdate.forEach(user => {
                if (messages[user] && messages[user][chatId] && messages[user][chatId][index]) {
                    messages[user][chatId][index] = {
                        deleted: true,
                        time: messages[user][chatId][index].time
                    };
                }
            });
            
            await saveAllData();
            loadMessages();
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
        };

        window.sendMessage = async function() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !currentUser || !currentChatPartner) return;

            const msg = {
                type: 'text',
                sender: currentUser,
                text: text,
                time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                forwarded: false,
                deleted: false
            };

            await saveMessage(msg);
            input.value = '';
            loadMessages();
            
            if (currentChatType === 'private') {
                sendMessageNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${currentUser}`, text);
            } else if (currentChatType === 'group') {
                const group = groups[currentChatPartner];
                if (group) {
                    sendMessageNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ ${group.name || '–≥—Ä—É–ø–ø–µ'}`, `${currentUser}: ${text}`);
                }
            } else if (currentChatType === 'channel') {
                const channel = channels[currentChatPartner];
                if (channel) {
                    sendMessageNotification(`–ù–æ–≤—ã–π –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª–µ ${channel.name || '–∫–∞–Ω–∞–ª–µ'}`, text);
                }
            }
        };

        window.sendImage = async function() {
            const input = document.getElementById('file-input');
            if (!input.files?.[0] || !currentUser || !currentChatPartner) return;

            const reader = new FileReader();
            reader.onload = async e => {
                const msg = {
                    type: 'image',
                    sender: currentUser,
                    content: e.target.result,
                    time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                    forwarded: false,
                    deleted: false
                };

                await saveMessage(msg);
                input.value = '';
                loadMessages();
                
                if (currentChatType === 'private') {
                    sendMessageNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${currentUser}`, 'üì∑ –§–æ—Ç–æ');
                } else if (currentChatType === 'group') {
                    const group = groups[currentChatPartner];
                    if (group) {
                        sendMessageNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ ${group.name || '–≥—Ä—É–ø–ø–µ'}`, `${currentUser}: üì∑ –§–æ—Ç–æ`);
                    }
                } else if (currentChatType === 'channel') {
                    const channel = channels[currentChatPartner];
                    if (channel) {
                        sendMessageNotification(`–ù–æ–≤—ã–π –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª–µ ${channel.name || '–∫–∞–Ω–∞–ª–µ'}`, 'üì∑ –§–æ—Ç–æ');
                    }
                }
            };
            reader.readAsDataURL(input.files[0]);
        };

        async function saveMessage(msg) {
            if (!currentUser || !currentChatPartner) return;
            
            if (currentChatType === 'private') {
                const chatId = [currentUser, currentChatPartner].sort().join('_');
                
                if (!messages[currentUser]) messages[currentUser] = {};
                if (!messages[currentUser][chatId]) messages[currentUser][chatId] = [];
                messages[currentUser][chatId].push(msg);

                if (!messages[currentChatPartner]) messages[currentChatPartner] = {};
                const partnerId = [currentChatPartner, currentUser].sort().join('_');
                if (!messages[currentChatPartner][partnerId]) messages[currentChatPartner][partnerId] = [];
                messages[currentChatPartner][partnerId].push(msg);

                if (!(contacts[currentChatPartner] || []).includes(currentUser)) {
                    if (!strangers[currentChatPartner]) strangers[currentChatPartner] = [];
                    if (!strangers[currentChatPartner].includes(currentUser)) {
                        strangers[currentChatPartner].push(currentUser);
                    }
                }
            } else if (currentChatType === 'group') {
                if (!messages[currentUser]) messages[currentUser] = {};
                if (!messages[currentUser][currentChatPartner]) messages[currentUser][currentChatPartner] = [];
                messages[currentUser][currentChatPartner].push(msg);
                
                const group = groups[currentChatPartner];
                if (group && group.members) {
                    group.members.forEach(m => {
                        if (m !== currentUser) {
                            if (!messages[m]) messages[m] = {};
                            if (!messages[m][currentChatPartner]) messages[m][currentChatPartner] = [];
                            messages[m][currentChatPartner].push(msg);
                        }
                    });
                }
            } else if (currentChatType === 'channel') {
                const channel = channels[currentChatPartner];
                if (channel && (channel.owner === currentUser || (channel.admins && channel.admins.includes(currentUser)))) {
                    if (!messages[currentUser]) messages[currentUser] = {};
                    if (!messages[currentUser][currentChatPartner]) messages[currentUser][currentChatPartner] = [];
                    messages[currentUser][currentChatPartner].push(msg);
                    
                    if (channel.subscribers) {
                        channel.subscribers.forEach(sub => {
                            if (sub !== currentUser) {
                                if (!messages[sub]) messages[sub] = {};
                                if (!messages[sub][currentChatPartner]) messages[sub][currentChatPartner] = [];
                                messages[sub][currentChatPartner].push(msg);
                            }
                        });
                    }
                }
            }
            
            await saveAllData();
        }

        function getLastMessagePreview(contact) {
            if (!currentUser) return '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
            
            const chatId = [currentUser, contact].sort().join('_');
            const msgs = (messages[currentUser] && messages[currentUser][chatId]) ? messages[currentUser][chatId] : [];
            if (!msgs.length) return '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
            const last = msgs[msgs.length - 1];
            if (!last) return '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
            if (last.deleted) return 'üóëÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
            if (last.type === 'image') return 'üì∑ –§–æ—Ç–æ';
            return `${last.sender === currentUser ? '–í—ã: ' : ''}${last.text ? last.text.substring(0, 20) : ''}${last.text && last.text.length > 20 ? '...' : ''}`;
        }

        window.backToMain = function() {
            showScreen('main-screen');
            currentChatPartner = null;
            loadChats();
            loadGroups();
            loadChannels();
            loadStrangers();
        };

        window.openImageModal = function(src) {
            document.getElementById('modal-image').src = src;
            document.getElementById('image-modal').classList.add('active');
        };

        window.openAvatarModal = function() {
            document.getElementById('avatar-modal').classList.add('active');
        };

        window.closeAvatarModal = function() {
            document.getElementById('avatar-modal').classList.remove('active');
        };

        window.updateAvatar = async function(input) {
            if (!input.files?.[0] || !currentUser) return;
            
            const reader = new FileReader();
            reader.onload = async e => {
                userData[currentUser].avatar = e.target.result;
                await saveAllData();
                updateUserAvatar();
                window.closeAvatarModal();
                showNotification('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            };
            reader.readAsDataURL(input.files[0]);
        };

        // ===========================================
        // –§–£–ù–ö–¶–ò–ò –ì–†–£–ü–ü
        // ===========================================
        
        window.showCreateGroupModal = function() {
            if (!currentUser) {
                showNotification('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç', 'error');
                return;
            }
            
            const modal = document.getElementById('group-modal');
            const list = document.getElementById('group-members-list');
            
            if (!modal || !list) return;
            
            const userContacts = contacts[currentUser] || [];
            if (userContacts.length === 0) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã');
                return;
            }

            list.innerHTML = userContacts.map(c => `
                <div class="member-item">
                    <input type="checkbox" value="${c}" id="member-${c}">
                    <label for="member-${c}">${c}</label>
                </div>
            `).join('');
            
            modal.classList.add('active');
        };

        window.closeGroupModal = function() {
            document.getElementById('group-modal').classList.remove('active');
            document.getElementById('group-name').value = '';
            document.getElementById('group-avatar').style.backgroundImage = 'none';
            document.getElementById('group-avatar').innerHTML = '<span>üì∑</span>';
        };

        window.previewGroupAvatar = function(input) {
            if (!input.files?.[0]) return;
            
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('group-avatar').style.backgroundImage = `url('${e.target.result}')`;
                document.getElementById('group-avatar').style.backgroundSize = 'cover';
                document.getElementById('group-avatar').innerHTML = '';
            };
            reader.readAsDataURL(input.files[0]);
        };

        window.createGroup = async function() {
            if (!currentUser) return;
            
            const name = document.getElementById('group-name').value.trim();
            const members = Array.from(document.querySelectorAll('#group-members-list input:checked')).map(cb => cb.value);
            
            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
                return;
            }
            
            if (members.length === 0) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');
                return;
            }
            
            let avatar = '';
            const av = document.getElementById('group-avatar');
            if (av.style.backgroundImage) {
                avatar = av.style.backgroundImage.replace(/url\(["']?|["']?\)/g, '');
            }
            
            const id = 'group_' + Date.now();
            groups[id] = {
                name, avatar,
                members: [currentUser, ...members],
                admins: [currentUser]
            };
            
            members.forEach(m => {
                if (!groups[m]) groups[m] = [];
                groups[m].push(id);
            });
            
            if (!groups[currentUser]) groups[currentUser] = [];
            groups[currentUser].push(id);
            
            await saveAllData();
            window.closeGroupModal();
            loadGroups();
            window.switchTab('groups');
            showNotification('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞');
        };

        window.openGroupManage = function(id) {
            if (!currentUser) return;
            
            const group = groups[id];
            if (!group) return;

            document.getElementById('manage-group-title').textContent = `–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${group.name || '–≥—Ä—É–ø–ø–æ–π'}`;
            document.getElementById('manage-group-name').value = group.name || '';
            
            const av = document.getElementById('manage-group-avatar');
            if (group.avatar) {
                av.style.backgroundImage = `url('${group.avatar}')`;
                av.style.backgroundSize = 'cover';
                av.innerHTML = '';
            } else {
                av.style.backgroundImage = 'none';
                av.innerHTML = group.name ? group.name[0].toUpperCase() : 'G';
            }
            
            const contacts_list = contacts[currentUser] || [];
            const nonMembers = contacts_list.filter(c => !group.members || !group.members.includes(c));
            
            document.getElementById('add-members-list').innerHTML = nonMembers.length ? 
                nonMembers.map(c => `
                    <div class="member-item">
                        <input type="checkbox" value="${c}" id="add-${c}">
                        <label for="add-${c}">${c}</label>
                    </div>
                `).join('') : 
                '<p style="color: #666; padding: 10px;">–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>';
            
            document.getElementById('manage-members-list').innerHTML = group.members ? group.members.map(m => {
                const style = userData[m]?.avatar ? 
                    `background-image: url('${userData[m].avatar}'); background-size: cover;` : 
                    'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
                
                return `
                    <div class="member-item">
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                            <div class="avatar small" style="${style}"></div>
                            <span>${m}</span>
                            ${group.admins && group.admins.includes(m) ? '<span class="admin-badge">–ê–¥–º–∏–Ω</span>' : ''}
                        </div>
                        ${m !== currentUser && group.admins && group.admins.includes(currentUser) ? `
                            <button class="btn-secondary" style="padding:5px 10px;" onclick="window.toggleAdmin('${id}', '${m}')">
                                ${group.admins.includes(m) ? 'üë§' : 'üëë'}
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('') : '';
            
            document.getElementById('group-manage-modal').dataset.groupId = id;
            document.getElementById('group-manage-modal').classList.add('active');
        };

        window.closeGroupManageModal = function() {
            document.getElementById('group-manage-modal').classList.remove('active');
        };

        window.updateGroupAvatar = function(input) {
            if (!input.files?.[0]) return;
            
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('manage-group-avatar').style.backgroundImage = `url('${e.target.result}')`;
                document.getElementById('manage-group-avatar').style.backgroundSize = 'cover';
                document.getElementById('manage-group-avatar').innerHTML = '';
            };
            reader.readAsDataURL(input.files[0]);
        };

        window.toggleAdmin = async function(groupId, member) {
            if (!currentUser) return;
            
            const group = groups[groupId];
            if (!group) return;
            
            if (!group.admins) group.admins = [];
            
            if (group.admins.includes(member)) {
                group.admins = group.admins.filter(a => a !== member);
            } else {
                group.admins.push(member);
            }
            await saveAllData();
            window.openGroupManage(groupId);
        };

        window.saveGroupSettings = async function() {
            if (!currentUser) return;
            
            const modal = document.getElementById('group-manage-modal');
            if (!modal) return;
            
            const id = modal.dataset.groupId;
            const group = groups[id];
            if (!group) return;
            
            const newName = document.getElementById('manage-group-name').value.trim();
            if (newName) group.name = newName;
            
            const av = document.getElementById('manage-group-avatar');
            if (av.style.backgroundImage) {
                group.avatar = av.style.backgroundImage.replace(/url\(["']?|["']?\)/g, '');
            }
            
            const newMembers = Array.from(document.querySelectorAll('#add-members-list input:checked')).map(cb => cb.value);
            if (newMembers.length) {
                newMembers.forEach(m => {
                    if (!group.members) group.members = [];
                    if (!group.members.includes(m)) {
                        group.members.push(m);
                        if (!groups[m]) groups[m] = [];
                        if (!groups[m].includes(id)) groups[m].push(id);
                    }
                });
            }
            
            await saveAllData();
            window.closeGroupManageModal();
            loadGroups();
            
            if (currentChatPartner === id) {
                document.getElementById('chat-with').textContent = group.name || '–ì—Ä—É–ø–ø–∞';
            }
            
            showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        };

        window.deleteGroup = function() {
            if (!currentUser) return;
            
            const modal = document.getElementById('group-manage-modal');
            if (!modal) return;
            
            const id = modal.dataset.groupId;
            
            showConfirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?', '–≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å', async () => {
                const group = groups[id];
                if (!group) return;
                
                if (group.members) {
                    group.members.forEach(m => {
                        if (groups[m]) {
                            groups[m] = groups[m].filter(g => g !== id);
                        }
                    });
                }
                
                delete groups[id];
                if (pinned.groups) {
                    pinned.groups = pinned.groups.filter(g => g !== id);
                }
                
                await saveAllData();
                window.closeGroupManageModal();
                loadGroups();
                
                if (currentChatPartner === id) window.backToMain();
                showNotification('–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞');
            });
        };

        // ===========================================
        // –§–£–ù–ö–¶–ò–ò –ö–ê–ù–ê–õ–û–í
        // ===========================================
        
        window.showCreateChannelModal = function() {
            if (!currentUser) {
                showNotification('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç', 'error');
                return;
            }
            document.getElementById('channel-modal').classList.add('active');
        };

        window.closeChannelModal = function() {
            document.getElementById('channel-modal').classList.remove('active');
            document.getElementById('channel-name').value = '';
            document.getElementById('channel-description-input').value = '';
            document.getElementById('channel-avatar').style.backgroundImage = 'none';
            document.getElementById('channel-avatar').innerHTML = '<span>üì∑</span>';
        };

        window.previewChannelAvatar = function(input) {
            if (!input.files?.[0]) return;
            
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('channel-avatar').style.backgroundImage = `url('${e.target.result}')`;
                document.getElementById('channel-avatar').style.backgroundSize = 'cover';
                document.getElementById('channel-avatar').innerHTML = '';
            };
            reader.readAsDataURL(input.files[0]);
        };

        window.createChannel = async function() {
            if (!currentUser) return;
            
            const name = document.getElementById('channel-name').value.trim();
            const description = document.getElementById('channel-description-input').value.trim();
            
            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞');
                return;
            }
            
            let avatar = '';
            const av = document.getElementById('channel-avatar');
            if (av.style.backgroundImage) {
                avatar = av.style.backgroundImage.replace(/url\(["']?|["']?\)/g, '');
            }
            
            const id = 'channel_' + Date.now();
            channels[id] = {
                name,
                description,
                avatar,
                owner: currentUser,
                admins: [currentUser],
                subscribers: [currentUser]
            };
            
            await saveAllData();
            window.closeChannelModal();
            loadChannels();
            window.switchTab('channels');
            showNotification('–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω');
        };

        window.subscribeToChannel = async function(channelId) {
            if (!currentUser) return;
            
            const channel = channels[channelId];
            if (!channel) return;
            
            if (!channel.subscribers) channel.subscribers = [];
            if (!channel.subscribers.includes(currentUser)) {
                channel.subscribers.push(currentUser);
                await saveAllData();
                loadChannels();
                document.getElementById('search-input').value = '';
                document.getElementById('search-results').innerHTML = '';
                showNotification('–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª');
            }
        };

        window.openChannelManage = function(id) {
            if (!currentUser) return;
            
            const channel = channels[id];
            if (!channel) return;

            document.getElementById('manage-channel-title').textContent = `–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${channel.name || '–∫–∞–Ω–∞–ª–æ–º'}`;
            document.getElementById('manage-channel-name').value = channel.name || '';
            document.getElementById('manage-channel-description').value = channel.description || '';
            
            const av = document.getElementById('manage-channel-avatar');
            if (channel.avatar) {
                av.style.backgroundImage = `url('${channel.avatar}')`;
                av.style.backgroundSize = 'cover';
                av.innerHTML = '';
            } else {
                av.style.backgroundImage = 'none';
                av.innerHTML = channel.name ? channel.name[0].toUpperCase() : 'C';
            }
            
            const adminsList = document.getElementById('channel-admins-list');
            if (channel.subscribers) {
                adminsList.innerHTML = channel.subscribers.map(sub => {
                    if (sub === channel.owner) return '';
                    const isAdmin = channel.admins && channel.admins.includes(sub);
                    return `
                        <div class="subscriber-item">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <span>${sub}</span>
                                ${isAdmin ? '<span class="admin-badge">–ê–¥–º–∏–Ω</span>' : ''}
                            </div>
                            <button class="btn-secondary" style="padding:5px 10px;" onclick="window.toggleChannelAdmin('${id}', '${sub}')">
                                ${isAdmin ? 'üë§' : 'üëë'}
                            </button>
                        </div>
                    `;
                }).join('');
            } else {
                adminsList.innerHTML = '<p>–ù–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</p>';
            }
            
            const subsList = document.getElementById('channel-subscribers-list');
            if (channel.subscribers) {
                subsList.innerHTML = channel.subscribers.map(sub => {
                    if (sub === channel.owner) {
                        return `
                            <div class="subscriber-item">
                                <span>${sub} <span class="owner-badge">–í–ª–∞–¥–µ–ª–µ—Ü</span></span>
                            </div>
                        `;
                    }
                    return `
                        <div class="subscriber-item">
                            <span>${sub}</span>
                        </div>
                    `;
                }).join('');
            } else {
                subsList.innerHTML = '<p>–ù–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</p>';
            }
            
            document.getElementById('channel-manage-modal').dataset.channelId = id;
            document.getElementById('channel-manage-modal').classList.add('active');
        };

        window.closeChannelManageModal = function() {
            document.getElementById('channel-manage-modal').classList.remove('active');
        };

        window.updateChannelAvatar = function(input) {
            if (!input.files?.[0]) return;
            
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('manage-channel-avatar').style.backgroundImage = `url('${e.target.result}')`;
                document.getElementById('manage-channel-avatar').style.backgroundSize = 'cover';
                document.getElementById('manage-channel-avatar').innerHTML = '';
            };
            reader.readAsDataURL(input.files[0]);
        };

        window.toggleChannelAdmin = async function(channelId, member) {
            if (!currentUser) return;
            
            const channel = channels[channelId];
            if (!channel) return;
            
            if (!channel.admins) channel.admins = [];
            
            if (channel.admins.includes(member)) {
                channel.admins = channel.admins.filter(a => a !== member);
            } else {
                channel.admins.push(member);
            }
            
            await saveAllData();
            window.openChannelManage(channelId);
        };

        window.saveChannelSettings = async function() {
            if (!currentUser) return;
            
            const modal = document.getElementById('channel-manage-modal');
            if (!modal) return;
            
            const id = modal.dataset.channelId;
            const channel = channels[id];
            if (!channel) return;
            
            const newName = document.getElementById('manage-channel-name').value.trim();
            if (newName) channel.name = newName;
            
            channel.description = document.getElementById('manage-channel-description').value.trim();
            
            const av = document.getElementById('manage-channel-avatar');
            if (av.style.backgroundImage) {
                channel.avatar = av.style.backgroundImage.replace(/url\(["']?|["']?\)/g, '');
            }
            
            await saveAllData();
            window.closeChannelManageModal();
            loadChannels();
            
            if (currentChatPartner === id) {
                document.getElementById('chat-with').textContent = channel.name || '–ö–∞–Ω–∞–ª';
                const channelDesc = document.getElementById('channel-description');
                if (channelDesc) {
                    channelDesc.innerHTML = channel.description ? 
                        `<strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${escapeHtml(channel.description)}` : 
                        '<strong>–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</strong>';
                }
            }
            
            showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        };

        window.deleteChannel = function() {
            if (!currentUser) return;
            
            const modal = document.getElementById('channel-manage-modal');
            if (!modal) return;
            
            const id = modal.dataset.channelId;
            
            showConfirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª?', '–≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å', async () => {
                delete channels[id];
                if (pinned.channels) {
                    pinned.channels = pinned.channels.filter(c => c !== id);
                }
                
                await saveAllData();
                window.closeChannelManageModal();
                loadChannels();
                
                if (currentChatPartner === id) window.backToMain();
                showNotification('–ö–∞–Ω–∞–ª —É–¥–∞–ª–µ–Ω');
            });
        };

        // ===========================================
        // SMALLS –§–£–ù–ö–¶–ò–ò –° –•–†–ê–ù–ï–ù–ò–ï–ú –í LOCALSTORAGE
        // ===========================================
        
        window.showCreateSmallsModal = function() {
            if (!currentUser) {
                showNotification('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç', 'error');
                return;
            }
            document.getElementById('smalls-modal').classList.add('active');
        };

        window.closeSmallsModal = function() {
            document.getElementById('smalls-modal').classList.remove('active');
            document.getElementById('smalls-title').value = '';
            document.getElementById('smalls-description').value = '';
            document.getElementById('smalls-video-input').value = '';
            document.getElementById('smalls-preview').style.display = 'none';
            document.getElementById('upload-progress').style.display = 'none';
            currentSmallsVideo = null;
        };

        window.previewSmallsVideo = function(input) {
            if (input.files?.[0]) {
                const video = input.files[0];
                
                // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 8 –ú–ë
                const MAX_SIZE = 8 * 1024 * 1024; // 8 –ú–ë –≤ –±–∞–π—Ç–∞—Ö
                const sizeInMB = (video.size / (1024 * 1024)).toFixed(2);
                
                if (video.size > MAX_SIZE) {
                    showNotification(`‚ùå –í–∏–¥–µ–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ! ${sizeInMB} –ú–ë (–º–∞–∫—Å–∏–º—É–º 8 –ú–ë)`, 'error');
                    input.value = '';
                    return;
                }
                
                showNotification(`‚úÖ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${sizeInMB} –ú–ë`, 'success');
                
                const url = URL.createObjectURL(video);
                const preview = document.getElementById('smalls-preview');
                const videoEl = preview.querySelector('video');
                videoEl.src = url;
                preview.style.display = 'block';
                currentSmallsVideo = video;
            }
        };

        window.createSmalls = async function() {
            if (!currentUser) return;
            
            const title = document.getElementById('smalls-title').value.trim();
            const description = document.getElementById('smalls-description').value.trim();
            
            if (!title) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ');
                return;
            }
            
            if (!currentSmallsVideo) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ');
                return;
            }

            try {
                showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...', 'info');
                
                const progressBar = document.getElementById('upload-progress');
                const progressBarFill = document.getElementById('upload-progress-bar');
                progressBar.style.display = 'block';
                
                const videoId = 'video_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –≤ base64
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const videoData = e.target.result;
                    
                    const newVideo = {
                        id: videoId,
                        author: currentUser,
                        title: title,
                        description: description,
                        videoUrl: videoData,
                        chefCount: 0,
                        chefs: [],
                        comments: [],
                        createdAt: new Date().toISOString()
                    };
                    
                    smalls.unshift(newVideo);
                    allSmalls.unshift(newVideo);
                    
                    await saveAllData();
                    
                    progressBar.style.display = 'none';
                    window.closeSmallsModal();
                    
                    displayedSmalls = 0;
                    hasMore = true;
                    loadSmalls(true);
                    
                    const sizeInMB = (currentSmallsVideo.size / (1024 * 1024)).toFixed(2);
                    showNotification(`‚úÖ –í–∏–¥–µ–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ! (${sizeInMB} –ú–ë)`, 'success');
                };
                
                reader.readAsDataURL(currentSmallsVideo);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ:', error);
                document.getElementById('upload-progress').style.display = 'none';
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ', 'error');
            }
        };

        function loadSmalls(reset = false) {
            const feed = document.getElementById('smalls-feed');
            if (!feed) return;
            
            if (reset) {
                displayedSmalls = 0;
                hasMore = true;
                feed.innerHTML = '';
            }
            
            if (!hasMore || isLoading) return;
            
            isLoading = true;
            
            if (displayedSmalls === 0) {
                feed.innerHTML = '<div class="loading-indicator">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</div>';
            }
            
            setTimeout(() => {
                try {
                    const start = displayedSmalls;
                    const end = Math.min(start + SMALLS_PER_PAGE, allSmalls.length);
                    const videosToShow = allSmalls.slice(start, end);
                    
                    if (displayedSmalls === 0) {
                        feed.innerHTML = '';
                    }
                    
                    if (videosToShow.length === 0) {
                        if (displayedSmalls === 0) {
                            feed.innerHTML = '<div style="text-align: center; padding: 50px 20px; color: #666;"><h3>üé• SMALLS</h3><p>–ü–æ–∫–∞ –Ω–µ—Ç –≤–∏–¥–µ–æ. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p></div>';
                        }
                        hasMore = false;
                        isLoading = false;
                        return;
                    }
                    
                    videosToShow.forEach(video => {
                        const videoHtml = renderSmallsVideo(video);
                        feed.insertAdjacentHTML('beforeend', videoHtml);
                    });
                    
                    displayedSmalls = end;
                    hasMore = displayedSmalls < allSmalls.length;
                    
                    videosToShow.forEach(video => {
                        const videoEl = document.getElementById(`video-${video.id}`);
                        if (videoEl) {
                            videoEl.addEventListener('click', () => {
                                if (videoEl.paused) {
                                    videoEl.play();
                                } else {
                                    videoEl.pause();
                                }
                            });
                        }
                    });
                    
                    isLoading = false;
                    
                    if (!hasMore && allSmalls.length > 0) {
                        feed.insertAdjacentHTML('beforeend', '<div class="end-message">üèÅ –í—ã –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∏ –≤—Å–µ –≤–∏–¥–µ–æ</div>');
                    }
                    
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', e);
                    isLoading = false;
                }
            }, 300);
        }

        function setupInfiniteScroll() {
            const feed = document.getElementById('smalls-feed');
            if (!feed) return;
            
            feed.addEventListener('scroll', () => {
                if (!hasMore || isLoading) return;
                
                const scrollTop = feed.scrollTop;
                const scrollHeight = feed.scrollHeight;
                const clientHeight = feed.clientHeight;
                
                if (scrollTop + clientHeight >= scrollHeight - 200) {
                    loadSmalls();
                }
            });
        }

        function renderSmallsVideo(video) {
            const userHasChef = video.chefs && video.chefs.includes(currentUser);
            const avatarStyle = userData[video.author]?.avatar ? 
                `background-image: url('${userData[video.author].avatar}')` : 
                'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            
            return `
                <div class="smalls-video-container">
                    <video class="smalls-video" id="video-${video.id}" loop playsinline>
                        <source src="${video.videoUrl}" type="video/mp4">
                    </video>
                    <div class="smalls-info">
                        <div class="smalls-author" onclick="window.openProfile('${video.author}')">
                            <div class="smalls-author-avatar" style="${avatarStyle}"></div>
                            <div>
                                <div style="font-weight: bold;">${video.author}</div>
                                <div style="font-size: 0.8rem; opacity: 0.8;">–®–µ–¥–µ–≤—Ä–∏–∫—Å–æ–≤: ${userData[video.author]?.chefCount || 0}</div>
                            </div>
                        </div>
                        <div class="smalls-title">${escapeHtml(video.title)}</div>
                        <div class="smalls-description">${escapeHtml(video.description || '')}</div>
                        <div class="smalls-stats">
                            <div class="smalls-stat">
                                <span>üñºÔ∏è</span>
                                <span>${video.chefCount || 0}</span>
                            </div>
                            <div class="smalls-stat">
                                <span>üí¨</span>
                                <span>${video.comments?.length || 0}</span>
                            </div>
                        </div>
                        <button class="smalls-chef-button ${userHasChef ? 'active' : ''}" onclick="window.toggleChef('${video.id}')">
                            <span class="smalls-chef-icon">${userHasChef ? '‚úÖ' : 'üñºÔ∏è'}</span>
                            <span>${userHasChef ? '–û—Ç–º–µ–Ω–∏—Ç—å —à–µ–¥–µ–≤—Ä–∏–∫—Å' : '–≠—Ç–æ –∂–µ... –®–µ–¥–µ–≤—Ä!'}</span>
                        </button>
                        
                        <div class="smalls-comments-section">
                            ${renderComments(video)}
                        </div>
                        
                        <div class="smalls-add-comment">
                            <input type="text" id="comment-${video.id}" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                            <button onclick="window.addComment('${video.id}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderComments(video) {
            if (!video.comments || video.comments.length === 0) {
                return '<div style="padding: 15px; text-align: center; color: #999;">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>';
            }
            
            return video.comments.map(comment => {
                const avatarStyle = userData[comment.author]?.avatar ? 
                    `background-image: url('${userData[comment.author].avatar}')` : 
                    'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                
                return `
                    <div class="smalls-comment">
                        <div class="smalls-comment-avatar" style="${avatarStyle}"></div>
                        <div class="smalls-comment-content">
                            <div class="smalls-comment-author">${comment.author}</div>
                            <div class="smalls-comment-text">${escapeHtml(comment.text)}</div>
                            <div class="smalls-comment-time">${comment.time || ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleChef = async function(videoId) {
            if (!currentUser) {
                showNotification('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç', 'error');
                return;
            }
            
            const videoIndex = smalls.findIndex(v => v.id === videoId);
            if (videoIndex === -1) return;
            
            const video = smalls[videoIndex];
            
            if (!video.chefs) video.chefs = [];
            if (!video.chefCount) video.chefCount = 0;
            
            const userHasChef = video.chefs.includes(currentUser);
            
            if (userHasChef) {
                video.chefs = video.chefs.filter(u => u !== currentUser);
                video.chefCount--;
                
                if (userData[video.author]) {
                    if (!userData[video.author].chefCount) userData[video.author].chefCount = 0;
                    userData[video.author].chefCount = Math.max(0, (userData[video.author].chefCount || 0) - 1);
                }
                
                showNotification('–®–µ–¥–µ–≤—Ä–∏–∫—Å –æ—Ç–º–µ–Ω–µ–Ω');
            } else {
                video.chefs.push(currentUser);
                video.chefCount++;
                
                if (userData[video.author]) {
                    if (!userData[video.author].chefCount) userData[video.author].chefCount = 0;
                    userData[video.author].chefCount++;
                }
                
                showNotification('–®–µ–¥–µ–≤—Ä–∏–∫—Å –ø–æ—Å—Ç–∞–≤–ª–µ–Ω! üñºÔ∏è');
            }
            
            await saveAllData();
            loadSmalls(true);
        };

        window.addComment = async function(videoId) {
            if (!currentUser) {
                showNotification('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç', 'error');
                return;
            }
            
            const input = document.getElementById(`comment-${videoId}`);
            const text = input.value.trim();
            
            if (!text) return;
            
            const videoIndex = smalls.findIndex(v => v.id === videoId);
            if (videoIndex === -1) return;
            
            const video = smalls[videoIndex];
            
            if (!video.comments) video.comments = [];
            
            video.comments.push({
                author: currentUser,
                text: text,
                time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            });
            
            input.value = '';
            await saveAllData();
            loadSmalls(true);
        };

        window.openProfile = function(username) {
            if (!username) return;
            
            const profileScreen = document.getElementById('profile-screen');
            const profileName = document.getElementById('profile-name');
            const profileChefDisplay = document.getElementById('profile-chef-display');
            const profileAvatar = document.getElementById('profile-avatar');
            const profileVideos = document.getElementById('profile-videos');
            
            profileName.textContent = username;
            profileChefDisplay.textContent = userData[username]?.chefCount || 0;
            
            if (userData[username]?.avatar) {
                profileAvatar.style.backgroundImage = `url('${userData[username].avatar}')`;
                profileAvatar.style.backgroundSize = 'cover';
                profileAvatar.innerHTML = '';
            } else {
                profileAvatar.style.backgroundImage = 'none';
                profileAvatar.innerHTML = username[0].toUpperCase();
            }
            
            const userVideos = smalls.filter(v => v.author === username);
            if (userVideos.length === 0) {
                profileVideos.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –≤–∏–¥–µ–æ</p>';
            } else {
                profileVideos.innerHTML = userVideos.map(video => `
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea;">${escapeHtml(video.title)}</h4>
                        <p style="color: #666; font-size: 0.9rem;">${escapeHtml(video.description || '')}</p>
                        <div style="display: flex; gap: 15px; margin-top: 10px;">
                            <span>üñºÔ∏è ${video.chefCount || 0}</span>
                            <span>üí¨ ${video.comments?.length || 0}</span>
                        </div>
                    </div>
                `).join('');
            }
            
            showScreen('profile-screen');
        };

        // ===========================================
        // –§–£–ù–ö–¶–ò–ò –ü–ï–†–ï–°–´–õ–ö–ò
        // ===========================================
        
        window.showForwardModal = function(data) {
            if (!currentUser) return;
            
            try {
                messageToForward = JSON.parse(decodeURIComponent(data));
            } catch (e) {
                return;
            }
            
            const preview = document.getElementById('forward-message-preview');
            const list = document.getElementById('forward-list');
            const modal = document.getElementById('forward-modal');
            
            if (!preview || !list || !modal) return;
            
            if (messageToForward.type === 'text') {
                preview.textContent = `–ü–µ—Ä–µ—Å–ª–∞—Ç—å: ${messageToForward.text || ''}`;
            } else {
                preview.innerHTML = `–ü–µ—Ä–µ—Å–ª–∞—Ç—å: <img src="${messageToForward.content || ''}" style="max-width:100px;">`;
            }
            
            let items = [];
            
            (contacts[currentUser] || []).forEach(c => items.push({ id: c, type: 'private', name: c, avatar: userData[c] ? userData[c].avatar : null }));
            (groups[currentUser] || []).forEach(gid => {
                const g = groups[gid];
                if (g) items.push({ id: gid, type: 'group', name: g.name || '–ì—Ä—É–ø–ø–∞', avatar: g.avatar });
            });
            
            for (let channelId in channels) {
                const channel = channels[channelId];
                if (channel && (channel.owner === currentUser || (channel.admins && channel.admins.includes(currentUser))) && channel.subscribers && channel.subscribers.includes(currentUser)) {
                    items.push({ id: channelId, type: 'channel', name: channel.name || '–ö–∞–Ω–∞–ª', avatar: channel.avatar });
                }
            }
            
            if (items.length === 0) {
                list.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">–ù–µ—Ç —á–∞—Ç–æ–≤</p>';
            } else {
                list.innerHTML = items.map(i => {
                    const style = i.avatar ? 
                        `background-image: url('${i.avatar}'); background-size: cover;` : 
                        'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
                    
                    return `
                        <div class="forward-item" onclick="window.selectForwardTarget('${i.id}', '${i.type}')">
                            <div class="avatar small" style="${style}"></div>
                            <div>
                                <h4>${escapeHtml(i.name)}</h4>
                                <p>${i.type === 'private' ? '–ß–∞—Ç' : i.type === 'group' ? '–ì—Ä—É–ø–ø–∞' : '–ö–∞–Ω–∞–ª'}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            modal.classList.add('active');
        };

        window.selectForwardTarget = function(id, type) {
            document.querySelectorAll('.forward-item').forEach(i => i.classList.remove('selected'));
            if (event?.currentTarget) event.currentTarget.classList.add('selected');
            selectedForwardTarget = id;
            selectedForwardType = type;
        };

        window.forwardMessage = async function() {
            if (!currentUser || !selectedForwardTarget || !messageToForward) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è');
                return;
            }
            
            const msg = {
                type: messageToForward.type,
                sender: currentUser,
                text: messageToForward.type === 'text' ? messageToForward.text : undefined,
                content: messageToForward.type === 'image' ? messageToForward.content : undefined,
                time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                forwarded: true,
                deleted: false
            };
            
            const oldPartner = currentChatPartner;
            const oldType = currentChatType;
            
            currentChatPartner = selectedForwardTarget;
            currentChatType = selectedForwardType;
            
            await saveMessage(msg);
            
            currentChatPartner = oldPartner;
            currentChatType = oldType;
            
            window.closeForwardModal();
            showNotification('–ü–µ—Ä–µ—Å–ª–∞–Ω–æ');
        };

        window.closeForwardModal = function() {
            document.getElementById('forward-modal').classList.remove('active');
            messageToForward = null;
            selectedForwardTarget = null;
            selectedForwardType = null;
        };

        // ===========================================
        // –§–£–ù–ö–¶–ò–ò –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
        // ===========================================
        
        window.closeConfirmModal = function() {
            document.getElementById('confirm-modal').classList.remove('active');
            confirmCallback = null;
        };

        document.getElementById('confirm-yes').onclick = () => {
            if (confirmCallback) confirmCallback();
            window.closeConfirmModal();
        };

        // ===========================================
        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // ===========================================
        
        function showNotification(msg, type = 'info') {
            const n = document.createElement('div');
            n.className = `notification ${type}`;
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 2000);
        }

        function showConfirm(title, msg, cb) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = msg;
            confirmCallback = cb;
            document.getElementById('confirm-modal').classList.add('active');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===========================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ===========================================
        
        setupInfiniteScroll();

        if (currentUser) {
            setTimeout(() => {
                showScreen('main-screen');
                loadMainScreen();
            }, 100);
        }
    </script>
</body>
</html>